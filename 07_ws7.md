# Workshop 7: Factorial ANOVA: Different Designs and Assumptions

**Aims:**

-   To practice running and interpreting a factorial ANOVA for a repeated measures design.
-   To practice interpreting means for main effects in a 2x2 design.
-   To practice evaluating the assumption of normality.

## Exercise 1: Import Data

Before beginning make sure you load the relevant packages.

``` r
library(tidyverse)
library(afex)
library(car)
```

The data set this week includes data from a study looking at wellbeing scores after exercise. Participants completing a psychological wellbeing measure before and after two different types of exercise: running and swimming. Participants completed all conditions.

Import `exercise.csv` and inspect the data set, making note of the variable names.

``` r
mydata <- read_csv(NULL)
view(mydata)
names(mydata)
```

Given this is a repeated measures design, you should double check if the data are in long format...

``` r
longd <- mydata %>%
  pivot_longer(
    cols = starts_with("before") | starts_with("after"), # columns to pivot, anything that starts with "before" or "after"
    names_to = c("time", "exercise"), # names of new columns
    names_pattern = "(before|after)_(run|swim)", # pattern to separate columns
    values_to = "wellbeing") # Name of the value column
```

Once you have run this, `view()` the data file to see what has changed. You should also check the variable names using `names()`

``` r
view(longd)
names(longd)
```

You also need to ensure any factors are coded as such... As R also puts labels in alphabetical order, it makes sense to place "before" ahead of "after", so we can use `levels = c()` to make that switch.

``` r
longd$time <- factor(longd$time, levels = c("before", "after"))
longd$exercise <- factor(longd$exercise)
```

## Exercise 2: Descriptives

Use the code below to generate descriptive statistics.

``` r
desc <- longd %>%
  group_by(time, exercise) %>%
  summarise(m = mean(wellbeing), 
            sd = sd(wellbeing), 
            n = n())

view(desc)
```

How about a boxplot too? However, you will need to decide what to place on the x and y axis, and which variable should have a colour fill by replacing `NULL` below.

``` r
ggplot(longd, aes(x = NULL, y = NULL, fill = NULL)) +
  geom_boxplot() +
  theme_classic()
```

Answer question 2.1 on the worksheet.

## Exercise 3: Run the ANOVA Model

Using `aov_ez()` run the ANOVA model. You should replace `NULL` where necessary to match the data set in this workshop.

``` r
mod <- aov_ez(id = "NULL",
              dv = "NULL",
              within = c("NULL", "NULL"),
              type = 3,
              include_aov = TRUE,
              data = NULL)
```

Once you have successfully run the model, an object called `mod` should now appear in the environment panel. Let's interpret the model

``` r
mod$anova_table
```

Is the interaction significant? Decide for yourself. If it is, you should use the code from exercises 4-6 from last week's workshop (workshop 6).

If not, as the two independent variables each only have two levels, you can interpret any main effects by looking at the descriptive statistics and/or plots.

Remember to amend the group_by() line of code in the descriptives to work out the statistics for each independent variable separately (as shown in the lecture).

Use the hint below if needed.

---

<details>

<summary>ðŸ‘€ Click for a hint</summary>

```r
exercise <- longd %>%
  group_by(exercise) %>%
  summarise(m = mean(wellbeing), 
            sd = sd(wellbeing), 
            n = n())
view(exercise)
```

Now try to amend the code to find the descriptives for the main effect of `time`.

</details>

---

Answer questions 3.1-3.5 on the worksheet.

## Exercise 4: Check Model Assumptions

The assumption of Sphericity is automatically checked and corrected for (if necessary). However, for a repeated measures design with only two-levels for each independent variable, Sphericity does not apply.

This means for a 2x2 repeated measures design, we will only check normality of residuals.

``` r
# testing normality, looking at normal distribution of residuals from the model.
residuals <- residuals(mod) #pulls residuals from the model
qqPlot(residuals) #produces a qq-plot of residuals
hist(residuals, breaks = 20, main = "Histogram of Residuals", xlab = "Residuals", col = "lightblue") #histogram of residuals
shapiro.test(residuals) #Shapiro test for residuals
```

Next week you'll also check assumptions for a mixed-design, including checking homogeneity of variance.

**The next exercises are important to help you continue to develop your understanding of code, research methods, and statistics**

## Exercise 5: Data Visualisation

You might notice that many of the plots initially generated by R are not "publication" ready.

The code below is quite long, but have a go at running it and look at the graph it produces.

Keep in mind you will look at data visualisation in a little more detail in a few weeks...

Consider whether a figure like this might be useful for your upcoming lab report.

``` r
ggplot(longd, aes(x = time, y = wellbeing, fill = exercise)) +
  stat_summary(fun = mean, geom = "bar", position = position_dodge(), color = "black") +
  stat_summary(fun.data = mean_sdl, geom = "errorbar", 
               position = position_dodge(0.9), width = 0.25) +
  labs(
    title = NULL,   # leave this as NULL because APA figures do not use titles.
    x = "Time Point",  
    y = "Mean Wellbeing Score",
    fill = "Exercise") +
  scale_fill_manual(values = c("run" = "slategray4", "swim" = "slategray2"), 
                    labels = c("Run", "Swim")) +
  scale_x_discrete(labels = c("before" = "Before", "after" = "After")) +
  # layer 6: add the theme to tidy up
  theme_minimal(base_size = 14) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 1),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold"))
```

## Exercise 6: Understanding Designs

In the following exercises, the drop down will turn **green if correct** and **red if incorrect**.

### Look at the code below and answer the questions:

``` r
mod <- aov_ez(id = "id",
              between = c("group", "handedness"), 
              dv = "reaction_time", 
              type = 3,
              data = df)
```

> **Question 1: Based on the code above, what was the design of this study?**
>
> <select id="q1" onchange="checkAnswer('q1','B')"> <option value="">-- choose an answer --</option> <option value="A">A. Repeated Measures</option> <option value="B">B. Independent Measures</option> <option value="C">C. Mixed Design</option> </select>

> **Question 2: Based on the code above, what object name was the data set saved as?**
>
> <select id="q2" onchange="checkAnswer('q2','B')"> <option value="">-- choose an answer --</option> <option value="A">A. id</option> <option value="B">B. df</option> <option value="C">C. mod</option> </select>

### Look at the code below and answer the questions.

``` r
mod <- aov_ez(id = "id",
              between = "group",
              within = "time_point",
              dv = "anxiety", 
              type = 3,
              data = mydata)
```

> **Question 3: Based on the code above, what was the design of this study?**
>
> <select id="q3" onchange="checkAnswer('q3','C')"> <option value="">-- choose an answer --</option> <option value="A">A. Repeated Measures</option> <option value="B">B. Independent Measures</option> <option value="C">C. Mixed Design</option> </select>

> **Question 4: Based on the code above, what object name was the repeated condition called?**
>
> <select id="q4" onchange="checkAnswer('q4','C')"> <option value="">-- choose an answer --</option> <option value="A">A. group</option> <option value="B">B. anxiety</option> <option value="C">C. time_point</option> </select>

## Exercise 7: "Significant or Non-Significant, That is the question"

> **Question 5: You see a *p*-value reported as *p* \< .001.**
>
> Significant or non-significant? <select id="q5" onchange="checkAnswer('q5','Significant')"> <option value="">-- choose an answer --</option> <option value="Significant">Significant</option> <option value="Non-Significant">Non-Significant</option> </select>

> **Question 6: You see a *p*-value in RStudio as 4.237e-14**
>
> Significant or non-significant? <select id="q6" onchange="checkAnswer('q6','Significant')"> <option value="">-- choose an answer --</option> <option value="Significant">Significant</option> <option value="Non-Significant">Non-Significant</option> </select>

> **Question 7: You see a *p*-value in RStudio as 0.5364**
>
> Significant or non-significant? <select id="q7" onchange="checkAnswer('q7','Non-Significant')"> <option value="">-- choose an answer --</option> <option value="Significant">Significant</option> <option value="Non-Significant">Non-Significant</option> </select>

> **Question 8: You see a *p*-value in RStudio as 0.0593**
>
> Significant or non-significant? <select id="q8" onchange="checkAnswer('q8','Non-Significant')"> <option value="">-- choose an answer --</option> <option value="Significant">Significant</option> <option value="Non-Significant">Non-Significant</option> </select>

## Exercise 8: HELP! My Code Won't Work

A friend is trying to run some code. They want to run a factorial ANOVA and then pull out the estimated marginal means, but it is not working!

Use your expert code skills to identify where the issue is by looking through the code below.

``` r
mod <- aov_ez(id = "id",
              dv = "score",
              between = "treatment",
              within = "time",
              type = 3,
              include_aov = TRUE,
              data = mydata)
mod$anova_table

library(emmeans)
emms <- emmeans(mid, ~ treatment*time)

contrasts <- contrast(eemms,
          interaction = "pairwise", 
          simple = "each", 
          combine = FALSE, 
          adjust = "holm")
```

Take your time to look through the code and spot **two** issues and then answer the questions below.

> **Question 9: Based on the code above, what was the first issue?** <select id="q9" onchange="checkAnswer('q9','C')"> <option value="">-- choose an answer --</option> <option value="A">A. "treatment" is misspelled</option> <option value="B">B. include_aov should = FALSE</option> <option value="C">C. mod was spelled as "mid"</option> </select>

> **Question 10: Based on the code above, what was the second issue?** <select id="q10" onchange="checkAnswer('q10','A')"> <option value="">-- choose an answer --</option> <option value="A">A. eems should be emms</option> <option value="B">B. adjust = "holm" is incorrect</option> <option value="C">C. contrast is misspelled</option> </select>

---
Well Done. You have reached the end of the workshop
---

<!-- JS to check correctness -->

```{=html}
<script>
function checkAnswer(id, correctValue){
  var el = document.getElementById(id);
  if(el.value === "") {
    el.style.backgroundColor = "";    // reset
    return;
  }
  if(el.value === correctValue){
    el.style.backgroundColor = "#b6f5b6";  // green
  } else {
    el.style.backgroundColor = "#f7b6b6";  // red
  }
}
</script>
```
